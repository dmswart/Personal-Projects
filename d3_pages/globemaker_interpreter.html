<html>
<head>
<script src='http://d3js.org/d3.v3.min.js'></script>
<script src='./dmslib_core.js'></script>
<script src='./dmslib_point2d.js'></script>
<script src='./dmslib_point3d.js'></script>
<script src='./dmslib_xfrm.js'></script>
<script src='./globemaker_segment.js'></script>
<script src='./globemaker_relative_position.js'></script>
<script src='./globemaker_skeleton.js'></script>
<script src='./globemaker_parse.js'></script>
<script src='./globemaker_optimizer.js'></script>
</head>

<body>
<div style='width: 100%; height: 100%; overflow: hidden; position:relative;'>
    <img id='targetPicture' style='position:absolute; width:720px;' src=""/>
    <div id='output' style='width: 720px; position: absolute;'></div>
</div>
<div id='controls' style='position: absolute; left: 740px; top: 0px;'>
    <ul style="list-style: none;">
        <li> <textarea id="input" type="text" cols="40" rows="32" style="overflow:scroll" onchange="newSkeleton(this.value);">l 0</textarea> </li>
        <li>
            <button onclick="optimizeToTarget();">Optimize</button>
            <b> Target: </b>
            <input type="file" onchange="onTargetSelected(event)" value="chose target">
        </li>
        <li> <button onclick="randomize();">Randomize</button> </li>
    </ul>
</div>

<div hidden>
    <img id='targetData' src=""/>
</div>



</body>

</html>

<script>
    const size = 720;      // size of image
    let svg;               // d3 selection for base svg object
    let skel = {scale: 72.0}; // dummy skeleton object, with how many pixels correspond to radian
    let target;            // target image object

    function setupPreview() {
        svg = d3.select('#output').append('svg')
            .attr('width', size)
            .attr('height',size)
        svg.append('rect')
            .attr('width', '100%')
            .attr('height', '100%')
            .attr('stroke-width', 1)
            .attr('opacity', '0.4')
            .attr('fill', 'silver');
        svg.append('g').attr('id', 'grid')
            .attr('transform', 'translate(' + size/2 + ',' + size/2 + ')')
            .attr('stroke', 'none');
        svg.append('rect')
            .attr('width', '100%')
            .attr('height', '100%')
            .attr('stroke-width', 1)
            .attr('opacity', '0.4')
            .attr('fill', 'silver');
        svg.append('g').attr('id', 'lines')
            .attr('transform', 'translate(' + size/2 + ',' + size/2 + ')')
            .attr('stroke', 'blue')
            .attr('stroke-width', 2)
            .attr('fill', 'none');
        svg.append('g').attr('id', 'moves')
            .attr('transform', 'translate(' + size/2 + ',' + size/2 + ')')
            .attr('stroke', 'gray')
            .attr('stroke-width', 1)
            .attr('fill', 'none');
        svg.append('g').attr('id', 'move_on_plane')
            .attr('transform', 'translate(' + size/2 + ',' + size/2 + ')')
            .attr('stroke', 'gray')
            .attr('stroke-width', 1)
            .attr('fill', 'none');
    }

    function updateLines(skel) {
        let selection = svg.select('#lines').selectAll('path')
            .data(skel.list('line'), d => d.id);
        selection.enter().append('path')
            .attr('d', d => 'M' + d.x1 + ',' + d.y1 + 'L' + d.x2 + ',' + d.y2);
        selection.exit().remove();
        selection
            .attr('d', d => 'M' + d.x1 + ',' + d.y1 + 'L' + d.x2 + ',' + d.y2);

        selection = svg.select('#lines').selectAll('circle')
            .data(skel.list('line'), d => d.id);
        selection.enter().append('circle')
            .attr('r', 3)
            .attr('cx', d => d.x2)
            .attr('cy', d => d.y2);
        selection.exit().remove();
        selection
            .attr('cx', d => d.x2)
            .attr('cy', d => d.y2);
    }

    function updateMoves(skel) {
        // moves on plane
        let selection = svg.select('#move_on_plane').selectAll('path')
            .data(skel.list('move_on_plane'), d => d.id);
        selection.enter().append('path')
            .attr('d', d => 'M' + d.x1 + ',' + d.y1 + 'L' + d.x2 + ',' + d.y2)
            .attr('stroke-dasharray', '3,3');
        selection.exit().remove();
        selection
            .attr('d', d => 'M' + d.x1 + ',' + d.y1 + 'L' + d.x2 + ',' + d.y2)

        selection = svg.select('#move_on_plane').selectAll('circle')
            .data(skel.list('move_on_plane'), d => d.id);
        selection.enter().append('circle')
            .attr('r', 1)
            .attr('fill', 'gray')
            .attr('cx', d => d.x2)
            .attr('cy', d => d.y2);
        selection.exit().remove();
        selection
            .attr('cx', d => d.x2)
            .attr('cy', d => d.y2);

        // normal moves
        selection = svg.select('#moves').selectAll('path')
            .data(skel.list('move'), d => d.id);
        selection.enter().append('path')
            .attr('d', d => 'M' + d.x1 + ',' + d.y1 + 'L' + d.x2 + ',' + d.y2);
        selection.exit().remove();
        selection
            .attr('d', d => 'M' + d.x1 + ',' + d.y1 + 'L' + d.x2 + ',' + d.y2);

        selection = svg.select('#moves').selectAll('circle')
            .data(skel.list('move'), d => d.id);
        selection.enter().append('circle')
            .attr('r', 1)
            .attr('fill', 'gray')
            .attr('cx', d => d.x2)
            .attr('cy', d => d.y2);
        selection.exit().remove();
        selection
            .attr('cx', d => d.x2)
            .attr('cy', d => d.y2);
    }

    function updateGrid(skel) {
        const density = 100;   // grid sample density
        const gridData = [];
        for (let i = 0; i < density; i++) {
            for (let j = 0; j < density; j++) {
                let x = (i -(density/2)+ 0.5) * (size/density);
                let y = (j -(density/2)+ 0.5) * (size/density);
                gridData.push({
                    x: x,
                    y: y,
                    color: skel.colorOfCoordinate(x, y),
                    id: i * density + j});
            }
        }
        let selection = svg.select('#grid').selectAll('circle')
            .data(gridData, d => d.id);
        selection.enter().append('circle')
            .attr('r', 0.4 * size/density)
            .attr('cx', d => d.x)
            .attr('cy', d => d.y)
            .attr('fill', d => d.color);
        selection.exit().remove();
        selection
            .attr('r', 0.4 * size/density)
            .attr('cx', d => d.x)
            .attr('cy', d => d.y)
            .attr('fill', d => d.color);
    }

    function newSkeleton(skeleton_def) {
        skel = new Skeleton(skel.scale);
        if(deserializeSkeleton(skeleton_def, skel)) {
            // input text box successfully parsed: white background
            d3.select('#input').attr('style', 'background-color:white');
            d3.select('#input').property('value', serializeSkeleton(skel));

            updateLines(skel);
            updateMoves(skel);
            updateGrid(skel);
        } else {
            // input text box unsuccessful: pink background
            d3.select('#input').attr('style', 'background-color:pink');
        }
    }

    function onTargetSelected(ev) {
        // for looks
        let img = document.getElementById('targetPicture');
        img.src = ev.target.files[0].name;

        // for the pixels
        let imgdata = document.getElementById('targetData');
        let selectedFile = ev.target.files[0];
        let reader = new FileReader();

        reader.onload = function(ev) {
            imgdata.onload = function() {
                let imgdata = document.getElementById('targetData');
                let c = document.createElement('canvas');
                c.width = imgdata.width;
                c.height = imgdata.height;
                c.getContext('2d').drawImage(imgdata, 0, 0);

                target = c.getContext('2d').getImageData(0, 0, c.width, c.height);
                target.pixel = function(x, y) { x = Math.floor(x); y = Math.floor(y); return this.data[y*this.width*4 + x*4]; };
            };
            imgdata.src = ev.target.result;
        };
        reader.readAsDataURL(selectedFile);

    }

    function optimizeToTarget() {
        optimizeSkeleton(skel, target, size);
        skel.init();
        d3.select('#input').property('value', serializeSkeleton(skel));
        updateLines(skel);
        updateMoves(skel);
        updateGrid(skel);
    }

    function randomize() {
        skel = getRandomSkeleton(10, skel.scale);
        skel.init();
        d3.select('#input').property('value', serializeSkeleton(skel));
        updateLines(skel);
        updateMoves(skel);
        updateGrid(skel);
    }

    setupPreview();
</script>
