<html>
<head>
    <script type='text/javascript' src='./d3.v3.min.js'></script>
    <script type='text/javascript' src='./d3-voronoi.v1.min.js'></script>
    <script type='text/javascript' src='./dmslib_core.js'></script>
    <script type='text/javascript' src='./dmslib_point2d.js'></script>
    <script type='text/javascript' src='./tsp_tour_generation.js'></script>
    <script type='text/javascript' src='./tsp_tour_utilities.js'></script>
    <script type='text/javascript' src='./tsp_solver.js'></script>
    <script type='text/javascript' src='./tsp_smoothing.js'></script>
</head>
<body>
    <div id='controls'>
        <input id='start_color' type='text' value='red' onchange='start_color=this.value;onColorChange();'> -
        <input id='start_idx' type='number' min='-1' value='-1' onchange='set_start_end_idx(this.valueAsNumber, end_idx);update_line();'> -
        <input id='inside_color' type='text' value='black' onchange='inside_color=this.value;onColorChange();'> -
        <input id='end_idx' type='number' min='0' value='256' onchange='set_start_end_idx(start_idx, this.valueAsNumber);update_line();'> -
        <input id='end_color' type='text' value='red' onchange='end_color=this.value;onColorChange();'>
        <button id='ground_mode' onclick='join_ends(!ends_joined);'>toggle ground</button>
        <br>

        <button onclick='get_tour("random");'>random</button>
        <button onclick='get_tour("house");'>house</button>
        <button onclick='get_tour("circle");'>circle</button>
        <button onclick='get_tour("spiral");'>spiral</button>
        <button id='import_tour' onclick='import_tour();'>import</button>
        <button id='export_tour' onclick='export_tour();'>export</button>
        <label for='tour_svg_text'>svg:</label><input id='tour_svg_text' type='text' value=''>
        <button onclick='tour = tour.reverse();update_line();'>ɿυoT</button>
        <br><br>

        <input type='file' onchange='onTargetSelected(event)' value='chose target'/>
        <label for='requested_size'>Pts:</label> <input id='requested_size' type='number' value=256 onchange='request_size(this.valueAsNumber);'>
        <button onclick='get_tour("target");'>target</button>
        <input type='button' id='Stipple' onclick='go("Stipple")' value='Stipple'/>
        <input type='button' id='TSP' onclick='go("TSP")' value='TSP'/>
        <input type='button' id='Smooth' onclick='go("Smooth")' value='Smooth'/>
        <br>

        <label for='smoothness'>Smoothness:</label> <input id='smoothness' type='number' min='0' max='10' value='1' onchange='set_smoothness(this.value);'/>
        <label for='sa_temp'>SA temp.:</label> <input id='sa_temp' type='number' min='0' max='10' value='0' onchange='set_sa_temp(this.value);'/>
        <input type='button' id='OptimizeAnimation' onclick='go("OptimizeAnimation")' value='OptimizeAnimation'/>
        Step: <button id='increase_stepsize' onclick='scale_stepsize(2);'>&lt;&lt;</button>
        <span id='stepsize'>1</span>
        <button id='reduce_stepsize' onclick='scale_stepsize(0.5)'>&gt;&gt;</button>
        <label for='pps'>Pixels per inside:</label> <input id='pps' type='number' min='1' max=1000 value=100 onchange='pps=this.value;'>
        <input type='button' id='Animate' onclick='go("Animate")' value='Animate'/>
        <input type='button' id='ReverseAnimate' onclick='reverse_animation()' value='ɘƚɒminA'/>
        <input type='button' id='TakeTour' onclick='go("TakeTour")' value='Take Tour'/>   
        <input type='button' id='Misc' onclick='go("Misc")' value='Misc'/>
        <br><br>
    </div>

    <div id='output'></div>

    <div id='target' hidden>
        <img id='target_picture' style='border-width:1px' src=""/>
    </div>
</body>
</html>


<script>
    var tour = [],
        size = new DMSLib.Point2D(1280, 720),
        start_color = 'red',
        inside_color = 'black',
        end_color = 'red',
        start_idx = 0,
        end_idx = 256,
        line_thickness = 3,
        requested_size = 256,
        timer,
        pps = 100,
        ends_joined = true,
        target = {width:size.x, height:size.y, pixel: function() {return 0;} };


    ///////////////////// D3 focused display routines.
    var svg = d3.select('#output').append('svg')
            .attr('width', size.x)
            .attr('height', size.y)
            .attr("style", "outline: thin solid red;");

    var line_space = svg.append('g');

    var start_line = line_space.append('path')
            .attr('id', 'start_line')
            .attr('stroke', start_color)
            .attr('stroke-width', line_thickness)
            .attr('fill', 'none');
    var inside_line = line_space.append('path')
            .attr('id', 'inside_line')
            .attr('stroke', inside_color)
            .attr('stroke-width', line_thickness)
            .attr('fill', 'none');
    var end_line = line_space.append('path')
            .attr('id', 'end_line')
            .attr('stroke', end_color)
            .attr('stroke-width', line_thickness)
            .attr('fill', 'none');

    var lineFunction = d3.svg.line()
            .x(function(d) { return d.x;})
            .y(function(d) { return d.y;})
            .interpolate('linear');
            // .interpolate('cardinal');

    var set_start_end_idx = function(start,end) {
        start_idx = start;
        end_idx = end;

        d3.select('#start_idx').property('value', start_idx);
        d3.select('#end_idx').property('value', end_idx);

        requested_size = end_idx - start_idx - 1;
        d3.select('#requested_size').property('value', requested_size);
        update_line();
    } 

    var request_size = function(num) {
        requested_size = num;

        increase_number(tour, requested_size, start_idx, end_idx);
        set_start_end_idx(start_idx, start_idx+requested_size+1);
    }

    var update_line = function(frame_time, easing) {
        var start_line_pts, inside_line_pts, end_line_pts;

        start_line_pts = (ends_joined ? [] : [{x:-1, y:tour[0].y}]).concat(tour.slice(0,start_idx+1));
        inside_line_pts = tour.slice(start_idx < 0 ? 0 : start_idx, end_idx+1);
        end_line_pts = tour.slice(end_idx, tour.length);

        var last_pt = ends_joined ? tour[0] : new DMSLib.Point2D(size.x+1, tour[tour.length-1].y);
        if (start_idx >= tour.length) {
            start_line_pts.push(last_pt);
        } else if (end_idx >= tour.length) {
            inside_line_pts.push(last_pt);
        } else {
            end_line_pts.push(last_pt);
        }
        

        if (frame_time===undefined) {
            start_line.attr('d', lineFunction(start_line_pts));
            inside_line.attr('d', lineFunction(inside_line_pts));
            end_line.attr('d', lineFunction(end_line_pts));
        } else {
            if(easing===undefined) {easing = 'linear';}
            start_line.transition().duration(frame_time).ease(easing)
                .attr('d', lineFunction(start_line_pts));
            inside_line.transition().duration(frame_time).ease(easing)
                .attr('d', lineFunction(inside_line_pts));
            end_line.transition().duration(frame_time).ease(easing)
                .attr('d', lineFunction(end_line_pts));
        }
    };

    var onColorChange = function() {
        d3.select('#start_line').attr('stroke', start_color);
        d3.select('#inside_line').attr('stroke', inside_color);
        d3.select('#end_line').attr('stroke', end_color);
    };

    ////////////////////////////////// Ground mode
    var join_ends = function(val) {
        ends_joined = val;
        set_start_end_idx(ends_joined ? -1 : 0,
                          ends_joined ? tour.length : tour.length-1);
    }


    ////////////////////////////////// Launching framework
    var go = function (method) {
        var method_fns = { 'Smooth' : smooth,
                           'Stipple' : stipple,
                           'TSP' : tsp,
                           'Animate' : animate,
                           'TakeTour' : take_tour,
                           'OptimizeAnimation' : optimize_animation,
                           'Misc' : misc_animation };
        var method_fn = method_fns[method];

        if (!timer) {
            d3.select('#' + method).property('value', 'Stop');
            method_fn();
        } else {
            clearTimeout(timer);
            timer = null;
            tour = tour.slice();
            d3.select('#' + method).property('value', method);
        }
    };

    var get_tour = function(method) {
        var method_fns = {'circle' : get_circle_pts,
                          'spiral' : get_spiral_pts,
                          'house' : get_house_pts,
                          'target': get_target_pts,
                          'random' : get_random_pts};
        var method_fn = method_fns[method];

        var start_pts = tour.slice(0,start_idx+1);
        var new_pts = method_fn(requested_size, target);
        var end_pts = tour.slice(end_idx);

        tour = start_pts.concat(new_pts).concat(end_pts);
        set_start_end_idx(start_pts.length-1, start_pts.length+new_pts.length);
    };

    var import_tour = function() {
        tour = get_pts_from_svg( document.getElementById('tour_svg_text').value );
        set_start_end_idx(ends_joined ? -1 : 0,
                          ends_joined ? tour.length : tour.length-1);
    };

    var export_tour = function() {
        document.getElementById('tour_svg_text').value = get_svg_from_pts(tour);
    };


    //////////////////////////////// Workhorse routines.
    var onTargetSelected = function(event) {
        var img = document.getElementById('target_picture');

        var selectedFile = event.target.files[0];
        var reader = new FileReader();

        reader.onload = function(event) {
            img.onload = function() {
                var img = document.getElementById('target_picture');
                var c = document.createElement('canvas');
                c.width = img.width;
                c.height = img.height;
                c.getContext('2d').drawImage(img, 0, 0);

                target = c.getContext('2d').getImageData(0, 0, c.width, c.height);
                target.pixel = function(x,y) { x=Math.floor(x); y=Math.floor(y); return this.data[y*this.width*4+x*4]; };
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(selectedFile);
    };

    var stipple = function (iter) {
        var voronoi = d3.voronoi()
                .x(function(d) {return d.x;})
                .y(function(d) {return d.y;})
                .extent([[-1, -1], [target.width, target.height]]);
        var diagram = voronoi(tour);

        // initialize accumulator variables
        var newpos = [];
        var sumofweights = [];
        var i;
        for(i=0; i<tour.length; i++) {
            newpos.push(new DMSLib.Point2D());
            sumofweights.push(0);
        }

        // add weighted images pixels to nearest cities
        for(var x=0; x<target.width; x++) {
            for (var y = 0; y < target.height; y++) {
                var idx = diagram.find(x,y).index;
                var weight = 255-target.pixel(x,y);
                if(weight) {
                    newpos[idx] = newpos[idx].add(new DMSLib.Point2D(x,y).mul(weight));
                    sumofweights[idx] += weight;
                }
            }
        }

        // calculate weighted average and show
        for(i=0; i<tour.length; i++) {
            if(sumofweights[i]) {
                tour[i] = newpos[i].div(sumofweights[i]);
            }
        }
        update_line();

        if(iter=== undefined) iter=20;
        if(iter!=0) {
            timer = setTimeout(function() {stipple(iter-1); }, 21);
        } else {
            clearTimeout(timer);
            timer = null;
            d3.select('#Stipple').property('value', 'Stipple');
        }
    };

    var find_ground = function(y) {
        var tmp, x, new_idx, target_x;
        if(start_idx === 0) {
            //find the rightmost non-blank point of our target
            target_x = -1;
            for(x=0; x<size.x; x++) {
                if (target.pixel(x, y) < 255) {
                    target_x = x;
                    break;
                }
            }

            new_idx = target_x >= 0 ?
                      find_closest_pt(tour, new DMSLib.Point2D(target_x, y)) :
                      find_direction_most_pt(tour, -1, 5);

            // swap
            tmp = new DMSLib.Point2D(tour[new_idx]);
            tour[new_idx] = new DMSLib.Point2D(tour[0]);
            tour[0] = new DMSLib.Point2D(tmp);
            tour[0].y = y;
        }

        if(end_idx === tour.length-1) {
            //find the leftmost non-blank point of our target
            for(x=size.x-1; x>=0; x--) {
                if(target.pixel(x,y) < 255) {
                    target_x = x;
                    break;
                }
            }

            new_idx = target_x >= 0 ?
                      find_closest_pt(tour, new DMSLib.Point2D(target_x, y)) :
                      find_direction_most_pt(tour, 1, 5);

            // swap
            tmp = new DMSLib.Point2D(tour[new_idx]);
            tour[new_idx] = new DMSLib.Point2D(tour[tour.length-1]);
            tour[tour.length-1] = new DMSLib.Point2D(tmp);
            tour[tour.length-1].y = y;
        }
    };

    var tsp = function (stage) {
        if(stage === undefined) {stage = 0;}

        if(stage === 0) {
            if(!ends_joined) { find_ground(467); }
        } else if(stage === 1) {
            randomize_pts(tour, start_idx, end_idx);
        } else if(stage === 2) {
		    do_insertion_heuristic(tour, start_idx, end_idx);
        } else if(stage === 3) {
            if(do_two_opt(tour, start_idx, end_idx, false) ) { stage--; }
        } else if(stage === 4) {
            if(do_two_opt(tour, start_idx, end_idx, true) ) { stage--; }
        } else if(stage === 5) {
            if(do_two_opt(tour, start_idx, end_idx, false) ) { stage--; }
        }

        stage++;

        if (stage === 6) {
            clearTimeout(timer);
            timer = null;
            d3.select('#TSP').property('value', 'TSP');
            if(num_frames() && start_idx < 0) { tour = match_other(tour, get_frame(0));}
            update_line();
        } else {
            update_line();
            timer = setTimeout(function() {tsp(stage); }, 21);
        }
    };

    var take_tour = function() {
        end_idx++;
        d3.select('#end_idx').property('value', end_idx);
        update_line();

        if(end_idx < tour.length - 1) {
            var frame_time = 1000 / pps;
            var t = (end_idx+1) / (tour.length+1);
            if(t < 0.2) {frame_time /= (t*5); }
            if(t > 0.8) {frame_time /= ((1-t)*5);}

            timer = setTimeout(function() {take_tour(); }, frame_time);
        } else {
            clearTimeout(timer);
            timer = null;
            d3.select('#TakeTour').property('value', 'Take Tour');
        }
    };

    var misc_animation = function(step) {
        if(step===undefined) {step=5;}

        if(step===0) {
            start_line.attr('d', lineFunction([]));
            inside_line.attr('d', lineFunction([{x:0,y:467}, {x:861.88,y:467}]));
            timer = setTimeout(function() {misc_animation(step+1);}, 1000);
        } else if(step===1) {
            inside_line
                .transition()
                .duration(3000)
                .ease('sin-in-out')
                .attr('d', lineFunction([{x:640,y:467},{x:3000,y:467}]));
            timer = setTimeout(function() {misc_animation(step+1);}, 3000);
        } else if(step===2) {
            start_line
                .attr('d', lineFunction([{x:-640,y:467},{x:-1,y:467}]));
            timer = setTimeout(function() {misc_animation(step+1);}, 6000);
        } else if(step===3) {
            start_line
                .transition()
                .duration(3000)
                .ease('sin-out')
                .attr('d', lineFunction([{x:-640,y:467},{x:640,y:467}]));
            timer = setTimeout(function() {misc_animation(step+1);}, 3000);
        } else if(step==5) {
            end_idx = start_idx;
            update_line();
            timer = setTimeout(function () { misc_animation(step + 1); }, 1000);
        } else if(step==6) {
            line_space.append('circle')
                .attr('r', 200)
                .attr('cx', tour[end_idx].x)
                .attr('cy', tour[end_idx].y)
                .attr('stroke', 'none')
                .attr('fill', inside_color)
                .attr('opacity', 0)
                .transition()
                    .duration(2000)
                    .ease('bounce-in')
                    .attr('opacity', 1)
                    .attr('r', line_thickness/2);
            d3.select('#TakeTour').property('value', 'Stop');
            d3.select('#Misc').property('value', 'Misc');
            timer = setTimeout(function() {take_tour();}, 2000);
        } else {
            clearTimeout(timer);
            timer = null;
            d3.select('#Misc').property('value', 'Misc');
        }
    };

    var animate = function(frame) {
        var frame_time, delay, easing;

        if(frame === undefined) {
            frame = 0;
            frame_time = undefined;
            delay = 1000;
        } else if (frame === num_frames()) {
            clearTimeout(timer);
            timer = null;
            d3.select('#Animate').property('value', 'Animate');
            tour = tour.slice();
            return;
        } else {
            frame_time = movement(get_frame(frame), get_frame(frame-1)) / pps * 1000;
            delay = frame_time;
            easing = 'linear';
        }

        if(frame===1) {
            easing = 'cubic-in';
            frame_time *= 3;
            delay *= 3;
        } else if(frame === num_frames()-1) {
            easing = 'cubic-out';
            frame_time *= 3;
            delay *= 3;
        }

        tour = get_frame(frame);
        update_line(frame_time, easing);
        timer = setTimeout(function () { animate(frame + 1); }, delay);
    };

    // TODO - move stippling to new file
    // TODO - 3d version: on a sphere.
</script>
